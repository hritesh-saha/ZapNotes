# name: Auto Build and Push Docker Images

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - 'notes/**'
#       - 'server/**'

# jobs:
#   build-and-push:
#     runs-on: ubuntu-latest

#     strategy:
#       matrix:
#         include:
#           - name: notes
#             path: notes
#             image: hriteshsaha4/zapnotes-frontend
#           - name: server
#             path: server
#             image: hriteshsaha4/zapnotes-backend

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3
#         with:
#           fetch-depth: 0  # fetch full commit history for git diff to work

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: Log in to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKERHUB_USERNAME }}
#           password: ${{ secrets.DOCKERHUB_TOKEN }}

#       - name: Detect changes in ${{ matrix.name }}
#         id: changes
#         run: |
#           echo "Checking for changes in ${{ matrix.path }}"
#           if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
#             echo "First commit detected, forcing build"
#             echo "changed=true" >> $GITHUB_OUTPUT
#           else
#             if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "^${{ matrix.path }}/"; then
#               echo "Changes detected in ${{ matrix.path }}"
#               echo "changed=true" >> $GITHUB_OUTPUT
#             else
#               echo "No changes detected in ${{ matrix.path }}"
#               echo "changed=false" >> $GITHUB_OUTPUT
#             fi
#           fi

#       - name: Build and Push ${{ matrix.image }}:dev
#         if: steps.changes.outputs.changed == 'true'
#         run: |
#           docker build -t ${{ matrix.image }}:dev ${{ matrix.path }}
#           docker push ${{ matrix.image }}:dev
name: Auto Build and Push Docker Images

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: notes
            path: notes
            image: hriteshsaha4/zapnotes-frontend
          - name: server
            path: server
            image: hriteshsaha4/zapnotes-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # This action reliably detects if files in the specific path have changed
      - name: Check for file changes
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: ${{ matrix.path }}/**

      # This single step builds, caches, and pushes the image
      - name: Build and push Docker image
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.path }}
          push: true
          tags: ${{ matrix.image }}:dev
          # Securely pass the backend URL ONLY to the frontend build
          build-args: |
            ${{ matrix.name == 'notes' && format('VITE_BACKEND_URL={0}', secrets.VITE_BACKEND_URL) || '' }}
          # Caching for much faster builds
          cache-from: type=registry,ref=${{ matrix.image }}:buildcache
          cache-to: type=registry,ref=${{ matrix.image }}:buildcache,mode=max